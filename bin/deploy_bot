#! /bin/bash

choice=""
choices=(0 1)
bot_dir=""
bot_adapter=""

function check_existing {
    bot_dir="$SNAP_USER_COMMON/$bot_name_$bot_adapter"
    overwrite=""
    if [[ -d $bot_dir ]]
    then
        read -p "Bot '$bot_name' already exists - overwrite? (y/N)> " overwrite
        if [[ "${overwrite,,}" = y* ]]
        then
            rm -rf $bot_dir
        else
            echo "Please choose a different bot name."
            exit
        fi
    fi
}

valid_choice=false
while [[ $valid_choice == false ]]
do
    echo "Please choose an adapter:
    1) rocketchat
    0) Quit"
    read -p "> " choice

    for item in "${choices[@]}"
    do
        [[ $item == $choice ]] && valid_choice=true
    done
done

# Common adapter properties
if [[ $choice != 0 ]]
then
    read -p "Desired bot name: " bot_name
fi

# Unique adapter properties
case $choice in
    0)
        echo "Bye!"
        exit
        ;;
    1)
        bot_adapter="rocketchat"
        check_existing
        mkdir $bot_dir && cd $bot_dir
        # TODO make these all into prompts
        export ROCKETCHAT_ROOM=''
        export LISTEN_ON_ALL_PUBLIC=true
        export ROCKETCHAT_USER=bot
        export ROCKETCHAT_PASSWORD=bot
        export ROCKETCHAT_AUTH=password
        # export ROCKETCHAT_URL=https://...
        # TODO make these into prompts too? Maybe ask "do you wish to configure advanced options?"
        # RESPOND_TO_DM
        # RESPOND_TO_EDITED
        # ROOM_ID_CACHE_SIZE
        # DM_ROOM_ID_CACHE_SIZE
        # ROOM_ID_CACHE_MAX_AGE
        ;;
    *)
        echo "Something went wrong!"
        exit
esac

yo hubot --no-insight --name="$bot_name" --adapter="$bot_adapter"
